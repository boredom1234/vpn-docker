<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>VPN Proxy Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      .glass {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      body {
        background-color: #0f172a;
        color: #e2e8f0;
      }
    </style>
  </head>
  <body class="min-h-screen p-6">
    <div class="max-w-6xl mx-auto space-y-6">
      <!-- Header -->
      <div class="flex justify-between items-center mb-8">
        <div>
          <h1 class="text-2xl font-bold text-blue-400">VPN Proxy Node</h1>
          <p class="text-slate-400 text-sm">System Status Dashboard</p>
        </div>
        <div class="flex gap-3">
          <button
            onclick="restartVPN()"
            class="px-4 py-2 bg-red-500/20 hover:bg-red-500/30 text-red-400 rounded-lg border border-red-500/50 transition-all text-sm font-medium"
          >
            Restart VPN
          </button>
        </div>
      </div>

      <!-- Stats Grid -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <!-- Status Card -->
        <div class="glass rounded-xl p-4">
          <div class="text-slate-400 text-xs uppercase tracking-wider mb-1">
            VPN Status
          </div>
          <div class="flex items-center gap-2">
            <div
              id="status-indicator"
              class="w-2 h-2 rounded-full bg-gray-500"
            ></div>
            <div id="vpn-status" class="text-xl font-semibold">Checking...</div>
          </div>
        </div>

        <!-- IP Card -->
        <div class="glass rounded-xl p-4">
          <div class="text-slate-400 text-xs uppercase tracking-wider mb-1">
            Public IP
          </div>
          <div id="public-ip" class="text-xl font-semibold font-mono">
            ---.---.---.---
          </div>
        </div>

        <!-- Uptime Card -->
        <div class="glass rounded-xl p-4">
          <div class="text-slate-400 text-xs uppercase tracking-wider mb-1">
            System Uptime
          </div>
          <div id="uptime" class="text-xl font-semibold">--:--:--</div>
        </div>

        <!-- Traffic Card -->
        <div class="glass rounded-xl p-4">
          <div class="text-slate-400 text-xs uppercase tracking-wider mb-1">
            Total Traffic
          </div>
          <div id="total-traffic" class="text-xl font-semibold">0 MB</div>
        </div>
      </div>

      <!-- Main Content Grid -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Traffic Chart -->
        <div class="glass rounded-xl p-4 lg:col-span-2">
          <h3 class="text-slate-400 text-xs uppercase tracking-wider mb-4">
            Live Bandwidth Usage
          </h3>
          <div class="h-64">
            <canvas id="trafficChart"></canvas>
          </div>
        </div>

        <!-- Logs -->
        <div class="glass rounded-xl p-4 flex flex-col h-[340px]">
          <h3 class="text-slate-400 text-xs uppercase tracking-wider mb-4">
            System Logs
          </h3>
          <div
            id="logs-container"
            class="flex-1 overflow-y-auto font-mono text-xs text-slate-300 bg-black/20 p-3 rounded-lg whitespace-pre-wrap"
          >
            Loading logs...
          </div>
        </div>
      </div>
    </div>

    <script>
      // Chart Setup
      const ctx = document.getElementById("trafficChart").getContext("2d");
      const trafficChart = new Chart(ctx, {
        type: "line",
        data: {
          labels: Array(20).fill(""),
          datasets: [
            {
              label: "Download (KB/s)",
              data: Array(20).fill(0),
              borderColor: "#3b82f6",
              tension: 0.4,
              borderWidth: 2,
              pointRadius: 0,
            },
            {
              label: "Upload (KB/s)",
              data: Array(20).fill(0),
              borderColor: "#10b981",
              tension: 0.4,
              borderWidth: 2,
              pointRadius: 0,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: true, labels: { color: "#94a3b8" } } },
          scales: {
            y: {
              grid: { color: "rgba(255,255,255,0.05)" },
              ticks: { color: "#64748b" },
            },
            x: { display: false },
          },
          animation: { duration: 0 },
        },
      });

      let lastRx = 0;
      let lastTx = 0;

      async function updateStats() {
        try {
          const response = await fetch("/api/status");
          const data = await response.json();

          // Update Status
          const statusEl = document.getElementById("vpn-status");
          const indicatorEl = document.getElementById("status-indicator");
          statusEl.textContent = data.vpn_status;

          if (data.vpn_status === "Connected") {
            statusEl.className = "text-xl font-semibold text-emerald-400";
            indicatorEl.className =
              "w-2 h-2 rounded-full bg-emerald-500 shadow-[0_0_10px_rgba(16,185,129,0.5)]";
          } else {
            statusEl.className = "text-xl font-semibold text-red-400";
            indicatorEl.className = "w-2 h-2 rounded-full bg-red-500";
          }

          // Update other text stats
          document.getElementById("public-ip").textContent = data.public_ip;
          document.getElementById("uptime").textContent = data.uptime;

          const totalMB = (
            (data.traffic.rx + data.traffic.tx) /
            1024 /
            1024
          ).toFixed(2);
          document.getElementById(
            "total-traffic"
          ).textContent = `${totalMB} MB`;

          // Update Chart
          if (lastRx > 0) {
            const rxSpeed = Math.max(0, (data.traffic.rx - lastRx) / 1024); // KB/s
            const txSpeed = Math.max(0, (data.traffic.tx - lastTx) / 1024); // KB/s

            const chartData = trafficChart.data;
            chartData.datasets[0].data.push(rxSpeed);
            chartData.datasets[0].data.shift();
            chartData.datasets[1].data.push(txSpeed);
            chartData.datasets[1].data.shift();
            trafficChart.update();
          }
          lastRx = data.traffic.rx;
          lastTx = data.traffic.tx;
        } catch (e) {
          console.error("Failed to fetch stats", e);
        }
      }

      async function updateLogs() {
        try {
          const response = await fetch("/api/logs");
          const data = await response.json();
          const logsContainer = document.getElementById("logs-container");
          logsContainer.textContent = data.logs;
          logsContainer.scrollTop = logsContainer.scrollHeight;
        } catch (e) {
          console.error("Failed to fetch logs", e);
        }
      }

      async function restartVPN() {
        if (!confirm("Are you sure you want to restart the VPN connection?"))
          return;
        try {
          const response = await fetch("/api/restart", { method: "POST" });
          const data = await response.json();
          alert(data.message);
        } catch (e) {
          alert("Failed to restart VPN");
        }
      }

      // Update loops
      setInterval(updateStats, 2000);
      setInterval(updateLogs, 5000);
      updateStats();
      updateLogs();
    </script>
  </body>
</html>
