<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>VPN Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap"
      rel="stylesheet"
    />
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ["Inter", "sans-serif"],
              mono: ["JetBrains Mono", "monospace"],
            },
            colors: {
              background: "#09090b",
              surface: "#18181b",
              surfaceHighlight: "#27272a",
            },
          },
        },
      };
    </script>
    <style>
      body {
        background-color: #09090b;
        color: #e4e4e7;
      }

      /* Custom Scrollbar */
      ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: #27272a;
        border-radius: 3px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #3f3f46;
      }

      .card {
        background-color: rgba(24, 24, 27, 0.6);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.08);
        transition: all 0.3s ease;
      }

      .card:hover {
        border-color: rgba(255, 255, 255, 0.12);
      }
    </style>
  </head>
  <body
    class="min-h-screen p-6 md:p-10 font-sans antialiased selection:bg-blue-500/30"
  >
    <div class="max-w-7xl mx-auto space-y-8">
      <!-- Header -->
      <div
        class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4"
      >
        <div>
          <h1 class="text-3xl font-light tracking-tight text-white">
            VPN Node
          </h1>
          <div class="flex items-center gap-2 mt-1.5">
            <span class="relative flex h-2 w-2">
              <span
                id="status-ping"
                class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75 hidden"
              ></span>
              <span
                id="status-dot"
                class="relative inline-flex rounded-full h-2 w-2 bg-zinc-600"
              ></span>
            </span>
            <p id="status-text" class="text-zinc-400 text-sm font-medium">
              Initializing...
            </p>
          </div>
        </div>
        <div class="flex gap-3">
          <button
            onclick="openConfigModal()"
            class="group relative px-5 py-2.5 bg-blue-500/5 hover:bg-blue-500/10 text-blue-400 rounded-lg border border-blue-500/20 hover:border-blue-500/30 transition-all duration-300 text-sm font-medium overflow-hidden"
          >
            <span class="relative z-10 flex items-center gap-2">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
              </svg>
              Configs
            </span>
          </button>
          <button
            onclick="restartVPN()"
            class="group relative px-5 py-2.5 bg-red-500/5 hover:bg-red-500/10 text-red-400 rounded-lg border border-red-500/20 hover:border-red-500/30 transition-all duration-300 text-sm font-medium overflow-hidden"
          >
            <span class="relative z-10 flex items-center gap-2">
              <svg
                class="w-4 h-4 transition-transform group-hover:rotate-180"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                ></path>
              </svg>
              Restart
            </span>
          </button>
        </div>
      </div>

      <!-- Stats Grid -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <!-- Status Detail -->
        <div class="card rounded-xl p-5">
          <div
            class="text-zinc-500 text-[11px] font-bold uppercase tracking-wider mb-2"
          >
            Connection Status
          </div>
          <div
            id="vpn-status-display"
            class="text-xl font-medium text-white tracking-tight"
          >
            Checking...
          </div>
        </div>

        <!-- IP Card -->
        <div class="card rounded-xl p-5">
          <div
            class="text-zinc-500 text-[11px] font-bold uppercase tracking-wider mb-2"
          >
            Public IP
          </div>
          <div
            id="public-ip"
            class="text-xl font-mono text-white tracking-tight"
          >
            ---.---.---.---
          </div>
        </div>

        <!-- Uptime Card -->
        <div class="card rounded-xl p-5">
          <div
            class="text-zinc-500 text-[11px] font-bold uppercase tracking-wider mb-2"
          >
            System Uptime
          </div>
          <div id="uptime" class="text-xl font-mono text-white tracking-tight">
            --:--:--
          </div>
        </div>

        <!-- Traffic Card -->
        <div class="card rounded-xl p-5">
          <div
            class="text-zinc-500 text-[11px] font-bold uppercase tracking-wider mb-2"
          >
            Total Traffic
          </div>
          <div
            id="total-traffic"
            class="text-xl font-mono text-white tracking-tight"
          >
            0 MB
          </div>
        </div>
      </div>

      <!-- Main Content -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-[500px]">
        <!-- Chart -->
        <div class="card rounded-xl p-6 lg:col-span-2 flex flex-col">
          <div class="flex justify-between items-center mb-6">
            <h3 class="text-zinc-400 text-sm font-medium">Network Activity</h3>
            <div class="flex gap-6 text-xs font-medium">
              <div class="flex items-center gap-2">
                <div
                  class="w-2 h-2 rounded-full bg-blue-500 shadow-[0_0_8px_rgba(59,130,246,0.5)]"
                ></div>
                <span class="text-zinc-400">Download</span>
              </div>
              <div class="flex items-center gap-2">
                <div
                  class="w-2 h-2 rounded-full bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.5)]"
                ></div>
                <span class="text-zinc-400">Upload</span>
              </div>
            </div>
          </div>
          <div class="flex-1 w-full relative min-h-0">
            <canvas id="trafficChart"></canvas>
          </div>
        </div>

        <!-- Logs -->
        <div
          class="card rounded-xl p-0 flex flex-col overflow-hidden border-zinc-800"
        >
          <div
            class="px-4 py-3 border-b border-white/5 bg-white/[0.02] flex justify-between items-center"
          >
            <div class="flex gap-4">
              <button
                onclick="setLogType('openvpn')"
                id="tab-openvpn"
                class="text-xs font-bold uppercase tracking-wider flex items-center gap-2 text-zinc-100 border-b-2 border-blue-500 pb-0.5 transition-colors"
              >
                <span class="w-2 h-2 rounded-full bg-blue-500"></span>
                OpenVPN
              </button>
              <button
                onclick="setLogType('tinyproxy')"
                id="tab-tinyproxy"
                class="text-xs font-bold uppercase tracking-wider flex items-center gap-2 text-zinc-500 hover:text-zinc-300 pb-0.5 transition-colors"
              >
                <span
                  class="w-2 h-2 rounded-full bg-purple-500 opacity-50"
                ></span>
                Tinyproxy
              </button>
              <button
                onclick="setLogType('dante')"
                id="tab-dante"
                class="text-xs font-bold uppercase tracking-wider flex items-center gap-2 text-zinc-500 hover:text-zinc-300 pb-0.5 transition-colors"
              >
                <span
                  class="w-2 h-2 rounded-full bg-orange-500 opacity-50"
                ></span>
                Dante
              </button>
            </div>
            <span id="log-filename" class="text-[10px] text-zinc-600 font-mono"
              >tail -f openvpn.log</span
            >
          </div>
          <div
            id="logs-container"
            class="flex-1 overflow-y-auto p-4 font-mono text-[11px] text-zinc-400 leading-relaxed whitespace-pre-wrap bg-[#0c0c0e]"
          >
            <span class="animate-pulse text-zinc-600">Waiting for logs...</span>
          </div>
        </div>
      </div>
      </div>
    </div>

    <!-- Config Modal -->
    <div
      id="config-modal"
      class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden items-center justify-center z-50 transition-opacity duration-300 opacity-0"
    >
      <div
        class="bg-[#18181b] border border-zinc-800 rounded-xl w-full max-w-lg p-6 shadow-2xl transform transition-all duration-300 scale-95"
      >
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-lg font-medium text-white">VPN Configurations</h3>
          <button
            onclick="closeConfigModal()"
            class="text-zinc-500 hover:text-white transition-colors"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>

        <!-- Upload Section -->
        <div class="mb-6 p-4 border border-dashed border-zinc-700 rounded-lg bg-zinc-900/50 hover:bg-zinc-900 transition-colors">
            <div class="flex items-center justify-between">
                <div class="text-sm text-zinc-400">
                    <span class="font-medium text-zinc-300">Upload .ovpn file</span>
                    <p class="text-xs mt-1">Drag & drop or click to browse</p>
                </div>
                <input type="file" id="config-upload" accept=".ovpn" class="hidden" onchange="handleFileUpload(this)">
                <button onclick="document.getElementById('config-upload').click()" class="px-3 py-1.5 bg-zinc-800 hover:bg-zinc-700 text-xs font-medium text-white rounded-md transition-colors">
                    Browse
                </button>
            </div>
        </div>

        <!-- Config List -->
        <div class="space-y-2 max-h-[300px] overflow-y-auto pr-2" id="config-list">
          <!-- Populated by JS -->
          <div class="text-center text-zinc-500 py-4">Loading...</div>
        </div>
      </div>
    </div>

    <script>
      // Chart Setup
      const ctx = document.getElementById("trafficChart").getContext("2d");

      // Gradient for charts
      const gradientRx = ctx.createLinearGradient(0, 0, 0, 400);
      gradientRx.addColorStop(0, "rgba(59, 130, 246, 0.2)");
      gradientRx.addColorStop(1, "rgba(59, 130, 246, 0)");

      const gradientTx = ctx.createLinearGradient(0, 0, 0, 400);
      gradientTx.addColorStop(0, "rgba(16, 185, 129, 0.2)");
      gradientTx.addColorStop(1, "rgba(16, 185, 129, 0)");

      const trafficChart = new Chart(ctx, {
        type: "line",
        data: {
          labels: Array(30).fill(""),
          datasets: [
            {
              label: "Download",
              data: Array(30).fill(0),
              borderColor: "#3b82f6",
              backgroundColor: gradientRx,
              borderWidth: 2,
              pointRadius: 0,
              pointHoverRadius: 4,
              fill: true,
              tension: 0.4,
            },
            {
              label: "Upload",
              data: Array(30).fill(0),
              borderColor: "#10b981",
              backgroundColor: gradientTx,
              borderWidth: 2,
              pointRadius: 0,
              pointHoverRadius: 4,
              fill: true,
              tension: 0.4,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: "index",
            intersect: false,
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: "rgba(24, 24, 27, 0.9)",
              titleColor: "#e4e4e7",
              bodyColor: "#a1a1aa",
              borderColor: "rgba(255,255,255,0.1)",
              borderWidth: 1,
              padding: 10,
              displayColors: true,
              callbacks: {
                label: function (context) {
                  return (
                    context.dataset.label +
                    ": " +
                    context.parsed.y.toFixed(1) +
                    " KB/s"
                  );
                },
              },
            },
          },
          scales: {
            y: {
              position: "right",
              grid: { color: "rgba(255,255,255,0.03)", drawBorder: false },
              ticks: { color: "#52525b", font: { size: 10, family: "Inter" } },
              beginAtZero: true,
            },
            x: {
              display: false,
              grid: { display: false },
            },
          },
          animation: { duration: 0 },
        },
      });

      let lastRx = 0;
      let lastTx = 0;
      let currentLogType = "openvpn";

      function setLogType(type) {
        currentLogType = type;

        // Update Tabs UI
        ["openvpn", "tinyproxy", "dante"].forEach((t) => {
          const btn = document.getElementById(`tab-${t}`);
          if (t === type) {
            btn.className =
              "text-xs font-bold uppercase tracking-wider flex items-center gap-2 text-zinc-100 border-b-2 border-blue-500 pb-0.5 transition-colors";
            btn.querySelector("span").classList.remove("opacity-50");
          } else {
            btn.className =
              "text-xs font-bold uppercase tracking-wider flex items-center gap-2 text-zinc-500 hover:text-zinc-300 pb-0.5 transition-colors";
            btn.querySelector("span").classList.add("opacity-50");
          }
        });

        // Update filename display
        const filenames = {
          openvpn: "tail -f openvpn.log",
          tinyproxy: "tail -f tinyproxy.log",
          dante: "tail -f danted.log",
        };
        document.getElementById("log-filename").textContent = filenames[type];

        // Clear current logs temporarily to show loading or just refresh immediately
        // document.getElementById("logs-container").textContent = "Loading...";
        updateLogs();
      }

      async function updateStats() {
        try {
          const response = await fetch("/api/status");
          const data = await response.json();

          // Update Status UI
          const statusTextEl = document.getElementById("status-text");
          const statusDotEl = document.getElementById("status-dot");
          const statusPingEl = document.getElementById("status-ping");
          const vpnStatusDisplay =
            document.getElementById("vpn-status-display");

          if (data.vpn_status === "Connected") {
            statusTextEl.textContent = "System Operational";
            statusTextEl.className = "text-emerald-400 text-sm font-medium";

            statusDotEl.className =
              "relative inline-flex rounded-full h-2 w-2 bg-emerald-500";
            statusPingEl.classList.remove("hidden");

            vpnStatusDisplay.textContent = "Active Tunnel";
            vpnStatusDisplay.className =
              "text-xl font-medium text-emerald-400 tracking-tight";
          } else {
            statusTextEl.textContent = "Disconnected";
            statusTextEl.className = "text-red-400 text-sm font-medium";

            statusDotEl.className =
              "relative inline-flex rounded-full h-2 w-2 bg-red-500";
            statusPingEl.classList.add("hidden");

            vpnStatusDisplay.textContent = "Disconnected";
            vpnStatusDisplay.className =
              "text-xl font-medium text-red-400 tracking-tight";
          }

          // Update other text stats
          document.getElementById("public-ip").textContent = data.public_ip;
          document.getElementById("uptime").textContent = data.uptime;

          const totalMB = (
            (data.traffic.rx + data.traffic.tx) /
            1024 /
            1024
          ).toFixed(2);
          document.getElementById(
            "total-traffic"
          ).textContent = `${totalMB} MB`;

          // Update Chart
          if (lastRx > 0) {
            const rxSpeed = Math.max(0, (data.traffic.rx - lastRx) / 1024); // KB/s
            const txSpeed = Math.max(0, (data.traffic.tx - lastTx) / 1024); // KB/s

            const chartData = trafficChart.data;
            chartData.datasets[0].data.push(rxSpeed);
            chartData.datasets[0].data.shift();
            chartData.datasets[1].data.push(txSpeed);
            chartData.datasets[1].data.shift();
            trafficChart.update();
          }
          lastRx = data.traffic.rx;
          lastTx = data.traffic.tx;
        } catch (e) {
          console.error("Failed to fetch stats", e);
        }
      }

      async function updateLogs() {
        try {
          const response = await fetch(`/api/logs?type=${currentLogType}`);
          const data = await response.json();
          const logsContainer = document.getElementById("logs-container");

          // Only scroll if we are already near the bottom or if it's the first load
          const isScrolledToBottom =
            logsContainer.scrollHeight - logsContainer.clientHeight <=
            logsContainer.scrollTop + 50;

          logsContainer.textContent = data.logs;

          if (isScrolledToBottom || logsContainer.textContent.length < 1000) {
            logsContainer.scrollTop = logsContainer.scrollHeight;
          }
        } catch (e) {
          console.error("Failed to fetch logs", e);
        }
      }

      async function restartVPN() {
        if (!confirm("Are you sure you want to restart the VPN connection?"))
          return;
        try {
          const response = await fetch("/api/restart", { method: "POST" });
          const data = await response.json();
          alert(data.message);
        } catch (e) {
          alert("Failed to restart VPN");
        }
      }

      // Config Modal Logic
      const modal = document.getElementById("config-modal");
      
      function openConfigModal() {
        modal.classList.remove("hidden");
        // Small delay to allow display:block to apply before opacity transition
        setTimeout(() => {
            modal.classList.remove("opacity-0");
            modal.querySelector("div").classList.remove("scale-95");
            modal.querySelector("div").classList.add("scale-100");
        }, 10);
        loadConfigs();
      }

      function closeConfigModal() {
        modal.classList.add("opacity-0");
        modal.querySelector("div").classList.remove("scale-100");
        modal.querySelector("div").classList.add("scale-95");
        setTimeout(() => {
            modal.classList.add("hidden");
        }, 300);
      }

      async function loadConfigs() {
        const listEl = document.getElementById("config-list");
        try {
            const res = await fetch("/api/configs");
            const data = await res.json();
            
            listEl.innerHTML = data.configs.map(conf => `
                <div class="flex items-center justify-between p-3 rounded-lg ${conf.active ? 'bg-blue-500/10 border border-blue-500/20' : 'bg-zinc-900 border border-zinc-800'}">
                    <div class="flex items-center gap-3">
                        <div class="w-2 h-2 rounded-full ${conf.active ? 'bg-blue-500' : 'bg-zinc-600'}"></div>
                        <span class="text-sm font-medium ${conf.active ? 'text-blue-400' : 'text-zinc-300'}">${conf.name}</span>
                    </div>
                    <div class="flex gap-2">
                        ${!conf.active ? `
                        <button onclick="activateConfig('${conf.name}')" class="p-1.5 text-zinc-400 hover:text-emerald-400 transition-colors" title="Activate">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                        </button>
                        <button onclick="deleteConfig('${conf.name}')" class="p-1.5 text-zinc-400 hover:text-red-400 transition-colors" title="Delete">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                        ` : '<span class="text-xs text-blue-500 font-medium px-2 py-1">Active</span>'}
                    </div>
                </div>
            `).join('');
        } catch(e) {
            listEl.innerHTML = '<div class="text-red-500 text-center text-sm">Failed to load configs</div>';
        }
      }

      async function activateConfig(filename) {
        if(!confirm(`Switch to ${filename}? This will restart the VPN.`)) return;
        
        try {
            const res = await fetch("/api/configs/activate", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({filename})
            });
            const data = await res.json();
            if(data.error) throw new Error(data.error);
            
            alert("Configuration switched! VPN is restarting...");
            closeConfigModal();
            // Reset status UI to show it's reconnecting
            document.getElementById("vpn-status-display").textContent = "Reconnecting...";
            document.getElementById("vpn-status-display").className = "text-xl font-medium text-yellow-500 tracking-tight";
        } catch(e) {
            alert(e.message);
        }
      }

      async function deleteConfig(filename) {
        if(!confirm(`Delete ${filename}?`)) return;
        
        try {
            const res = await fetch("/api/configs/delete", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({filename})
            });
            const data = await res.json();
            if(data.error) throw new Error(data.error);
            
            loadConfigs();
        } catch(e) {
            alert(e.message);
        }
      }

      async function handleFileUpload(input) {
        if(!input.files[0]) return;
        
        const formData = new FormData();
        formData.append("file", input.files[0]);
        
        try {
            const res = await fetch("/api/configs/upload", {
                method: "POST",
                body: formData
            });
            const data = await res.json();
            if(data.error) throw new Error(data.error);
            
            loadConfigs();
            input.value = ""; // Reset input
        } catch(e) {
            alert(e.message);
        }
      }

      // Update loops
      setInterval(updateStats, 2000);
      setInterval(updateLogs, 5000);
      updateStats();
      updateLogs();
    </script>
  </body>
</html>
